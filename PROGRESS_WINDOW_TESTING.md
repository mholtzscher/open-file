# Progress Window Testing Guide

This document describes how to test the progress window functionality in open-s3.

## Automated Tests

### Unit Tests

Test basic component properties and calculations:

```bash
npm test -- src/ui/progress-window.test.tsx
```

**Tests included:**

- Component interface and props validation
- Progress bar formatting
- Progress percentage clamping (0-100)
- String truncation
- Cancellation callback handling
- Multi-operation progress calculations

### Integration Tests

Test progress updates with simulated operations:

```bash
npm test -- src/ui/progress-window-integration.test.tsx
```

**Tests included:**

- Simulated download operations with progress chunks
- Multiple file operations with progress tracking
- Batch operation progress calculation
- Cancellation using AbortController
- Progress event formatting
- UI state updates during operations

### Run All Progress Tests

```bash
npm test -- src/ui/progress-window*.test.tsx
```

## Manual Testing

### 1. Build and Run the Application

```bash
npm run build
bun dist/index.js
```

### 2. Test Download/Upload Operations

1. Navigate to a directory in the app
2. Select multiple files
3. Press `d` to mark for download (or `u` for upload if available)
4. Press `w` to save/execute operations
5. Press `y` to confirm

**Expected behavior:**

- Progress window appears showing operation type
- Progress bar fills from 0% to 100%
- File name updates as each file is processed
- File counter shows "current/total" (e.g., "1/5")
- Window displays in the center of the terminal
- Blue border around the window

### 3. Test Cancellation

During an operation:

1. Press `Ctrl+C` to cancel
2. Progress window should stop updating
3. Status bar should show "Operation cancelled by user"
4. Remaining files should not be processed

**Expected behavior:**

- AbortController signals all pending operations
- Current operation completes or stops
- Yellow status message appears
- Progress window closes

### 4. Test Multiple Operations

1. Create several files to delete/copy/move
2. Execute multiple operations at once
3. Watch progress meter advance across all operations

**Expected behavior:**

- Progress tracks across all operations combined
- File name updates for current operation
- Counter increments with each operation
- Final percentage shows total progress

## Progress Window Elements

The progress window displays:

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Downloading files...       ┃
┃ [2/5] large-file.zip       ┃
┃ [==========          ] 50%  ┃
┃ Press Ctrl+C to cancel     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

- **Title**: Operation type (Downloading, Uploading, Deleting, etc.)
- **Filename**: Current file being processed with [current/total] counter
- **Progress bar**: Visual representation of completion (=== filled, spaces empty)
- **Percentage**: 0-100% complete
- **Cancel hint**: User instruction to cancel with Ctrl+C

## Testing Progress Callbacks

Progress events are generated by adapters and include:

```typescript
{
  operation: 'Downloading file.txt',
  bytesTransferred: 512000,
  totalBytes: 1024000,
  percentage: 50,
  currentFile: 'file.txt'
}
```

These are tested in the integration test suite which simulates:

- Chunk-based downloads (5% → 10% → 15%... 100%)
- Multiple files tracking
- Byte counting verification
- Percentage accuracy

## Debugging

### Enable Verbose Logging

To debug progress updates, modify `src/ui/s3-explorer.tsx` line ~467:

```typescript
const onProgress = (event: ProgressEvent) => {
  console.log('Progress event:', event); // Add this line
  // ... rest of progress update code
};
```

### Test with Mock Adapter

The mock adapter is useful for testing without real S3:

```bash
# In your app, switch to mock adapter
# This allows fast testing without network calls
```

### Check Progress State

React DevTools can inspect:

- `showProgress` state (boolean)
- `progressValue` state (0-100)
- `progressCurrentFile` state (string)
- `progressCurrentNum` state (number)
- `progressTotalNum` state (number)

## Test Scenarios

### Scenario 1: Single Large File Download

1. Select one large file
2. Execute download
3. Verify smooth progress from 0% to 100%
4. Verify file name stays consistent

### Scenario 2: Batch Delete with Cancellation

1. Select 10+ files for deletion
2. Press `w` then `y` to confirm
3. After progress reaches ~30%, press `Ctrl+C`
4. Verify remaining files are not deleted
5. Check status shows cancellation message

### Scenario 3: Mixed Operations

1. Create 3 files for deletion
2. Create 2 files for copying
3. Create 2 files for moving
4. Execute all 7 operations at once
5. Verify progress smoothly advances 0→100%
6. Verify counter increments through all 7

### Scenario 4: No Cancellation Needed

1. Execute operations
2. Let them complete fully
3. Verify progress reaches 100%
4. Verify success message appears
5. Verify window closes automatically
