PENDING CHANGES TRACKING SYSTEM - START HERE
=============================================

This research explains how open-s3 tracks and applies pending changes before syncing to S3.

WHAT IS THIS?
=============
An oil.nvim-style staging system where:
- Users mark changes locally (press 'dd' to delete)
- Changes show visually (strikethrough + red + ✗)
- Users review before confirming (press 'w')
- Changes execute with progress feedback
- Buffer reloads from S3 on completion

KEY FILES (Read in Order)
=========================

1. README.md (5 min read)
   - Quick overview and simple examples
   - The three layers of the system
   - Workflow trace with code pointers
   - Design patterns and key concepts

2. QUICK_REFERENCE.md (3 min lookup)
   - Function names and purposes
   - Visual indicators and status messages
   - Common code patterns
   - Error handling overview

3. COMPREHENSIVE_GUIDE.md (20 min deep dive)
   - Complete architecture with diagrams
   - Full code examples from actual implementation
   - State transitions and workflows
   - All files and their roles

4. INDEX.md (5 min navigation)
   - Exact file locations and line numbers
   - Connection diagrams
   - Performance characteristics
   - Testing checklist

CORE CONCEPT IN ONE SENTENCE
============================
Entries are marked in a Set, shown with visual indicators, converted to operations,
confirmed by the user, executed sequentially, then cleared after successful sync.

ENTRY POINTS FOR COMMON QUESTIONS
==================================

"How are changes tracked?"
→ See buffer-state layer in README.md
→ Read Section 3 of COMPREHENSIVE_GUIDE.md

"What files do I need to modify?"
→ Use INDEX.md to find exact file locations
→ Check useBufferState.ts, s3-explorer.tsx, buffer-view-react.tsx

"How do I add a new operation type?"
→ See COMPREHENSIVE_GUIDE.md Section 8 (Files and Roles)
→ Follow steps in INDEX.md (Future Extensions)

"What's the undo mechanism?"
→ Section 6 of COMPREHENSIVE_GUIDE.md
→ Search for "Snapshot-Based Undo"

"How does execution work?"
→ Section 5 of COMPREHENSIVE_GUIDE.md
→ Search for "createConfirmHandler" in s3-explorer.tsx

"Can multiple panes have different changes?"
→ Yes - see Multi-Pane Consideration in README.md
→ Each pane has independent deletedEntryIds set

QUICK FACTS
===========
- Pending changes stored in: Set<string> of entry IDs
- How many files to understand: 3 core, 5 supporting
- undo/redo: snapshot-based (full state restoration)
- Execution: sequential, not parallel
- Speed of mark/unmark: O(1) with Set
- State after quit without save: Lost
- State after save: Cleared and reloaded from S3

WORKFLOW AT A GLANCE
====================

dd   Mark entry for deletion
     Entry: stays visible, shows strikethrough + ✗ + red

u    Undo last action
     State: fully restored from snapshot

w    Save changes (show confirmation)
     Dialog: shows what operations will execute

Enter Confirm and execute
     Progress: shows each operation with feedback

Result: Buffer reloaded, marks cleared, S3 synced

WHAT MAKES IT DIFFERENT FROM GIT
=================================
Git staging:                open-s3 pending changes:
- Files added to index     - Entries marked in Set
- Stage specific hunks     - Mark entire entries only
- Commit to local repo     - Sync to S3 (remote)
- Can be uncommitted       - Can be unmarked
- Persistent              - Lost on quit without save

The key difference: open-s3 stages by marking, not by copying.

ARCHITECTURE OVERVIEW
=====================

Buffer State (useBufferState.ts)
├─ entries[]                    (All visible entries)
├─ deletedEntryIds: Set<string>(Which are marked)
├─ undoHistory[]               (Snapshots for undo)
└─ redoHistory[]               (Snapshots for redo)
        ↓ (User presses 'dd')
        ↓
Dialog State (useDialogState.ts)
├─ pendingOperations[]          (Marked → operations)
├─ activeDialog                 (Show confirmation)
└─ quitPendingChanges           (For quit dialog)
        ↓ (User presses 'w')
        ↓
Confirmation Dialog
├─ Show list of operations
└─ Wait for confirmation
        ↓ (User presses Enter)
        ↓
Execution Handler (createConfirmHandler)
├─ Loop through operations
├─ Call adapter.delete/create/move
├─ Update progress
└─ Reload buffer on success
        ↓
S3 Operations
└─ Actually delete/create/move

TESTING QUICK START
===================

1. Start the app
2. Navigate to a directory with files
3. Press 'dd' on a file
4. See: ✗ marker, strikethrough, red color
5. Press 'w'
6. See: Confirmation dialog with operation
7. Press Enter
8. See: Progress window, then success message
9. See: File gone from buffer

If that works, the system is functioning correctly.

DEBUGGING TIPS
==============

If marked entries don't show visually:
→ Check buffer-view-react.tsx line 175 (isMarkedForDeletion check)

If confirmation dialog doesn't appear:
→ Check s3-explorer.tsx line 463 (showConfirm call)

If operations don't execute:
→ Check createConfirmHandler starting at line 731

If buffer doesn't reload after:
→ Check line 840 (adapter.list call)

If marks don't clear after success:
→ Check line 843 (clearDeletionMarks call)

NEXT STEPS
==========

1. Read README.md for the mental model
2. Check your specific use case in QUICK_REFERENCE.md
3. Dive into COMPREHENSIVE_GUIDE.md for details
4. Use INDEX.md to find exact code locations
5. Search codebase with patterns from QUICK_REFERENCE.md

QUESTIONS ANSWERED BY THESE DOCS
=================================

Q: What state holds the pending changes?
A: Set<string> of entry IDs in useBufferState.ts

Q: How do I see what's pending?
A: Visual indicators: strikethrough + ✗ + red color in buffer

Q: Can users undo marked changes?
A: Yes, press 'u' to undo (restores everything)

Q: What happens if execution fails?
A: Continue to next operation, show error, user can retry

Q: Are changes persistent?
A: Only after 'w' (save) and confirmation - then synced to S3

Q: Can you mark and unmark same entry?
A: Yes, press 'dd' twice to toggle

Q: Does undo work after saving?
A: No - undo only works before save (before operations execute)

Q: How fast is checking if entry is marked?
A: O(1) - Set.has() operation

Q: What if user quits with pending changes?
A: Shows quit dialog with option to save first

Q: Do all panes share the same marks?
A: No - each pane has independent marks and undo history

MORE INFORMATION
================

- oil.nvim research: research/oil.nvim/
- Buffer state patterns: search useBufferState.ts for "snapshot"
- Dialog patterns: search useDialogState.ts for "reducer"
- UI rendering: see buffer-view-react.tsx for visual logic
- Keyboard dispatch: see useKeyboardDispatcher.ts for action routing

